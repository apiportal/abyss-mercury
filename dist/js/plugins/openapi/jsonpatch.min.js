!function(t,e){"object"==typeof exports?e(module.exports):"function"==typeof define&&define.amd?define(["exports"],e):(t.jsonpatch={},t.returnExports=e(t.jsonpatch))}(this,function(t){function a(t){Error.call(this,t),this.message=t}function c(t){Error.call(this,t),this.message=t}function o(t,r){!function(t){var e,n;if(!t.op)throw new a("Operation missing!");if(!u.hasOwnProperty(t.op))throw new a("Invalid operation!");if(!("path"in t))throw new a("Path missing!");for(n=u[t.op],e=0;e<n.length;e++)if(!(n[e]in t))throw new a(t.op+" must have key "+n[e])}(t);var e=t.op,o=new p(t.path),n=t.value,i=t.from?new p(t.from):null;switch(e){case"add":return function(t){return o.add(t,n,r)};case"remove":return function(t){return o.remove(t,r)};case"replace":return function(t){return o.replace(t,n,r)};case"move":if(o.subsetOf(i))throw new a("destination must not be a child of source");return function(t){var e=i.get(t),n=i.remove(t,r);return o.add(n,e,r)};case"copy":return function(t){var e=i.get(t);return o.add(t,e,r)};case"test":return function(t){if(!function t(e,n){var r;if(e===n)return!0;if(typeof e!=typeof n)return!1;if("object"!=typeof e)return!1;var o=f(e);if(o!==f(n))return!1;if(!o){for(r in e)if(Object.hasOwnProperty(e,r)&&(!Object.hasOwnProperty(n,r)||!t(e[r],n[r])))return!1;for(r in n)if(Object.hasOwnProperty(n,r)&&!Object.hasOwnProperty(e,r))return!1;return!0}if(e.length!=n.length)return!1;for(var i=0;i<e.length;i++)return t(e[i],n[i])}(o.get(t),n))throw new c("Test operation failed. Value did not match.");return t}}}var n,p,u,f;f=Array.isArray||function(t){return"[object Array]"==Object.prototype.toString.call(t)},t.apply_patch=function(t,e){return new n(e).apply(t)},(t.InvalidPatch=a).prototype=new Error,(t.PatchApplyError=c).prototype=new Error,t.JSONPointer=window.JSONPointer=p=function(t){var e,n,r=[];if(""!==(n=t.split("/"))[0])throw new a("JSONPointer must start with a slash (or be an empty string)!");for(e=1;e<n.length;e++)r[e-1]=n[e].replace(/~1/g,"/").replace(/~0/g,"~");this.path=r,this.length=r.length},p.prototype._get_segment=function(t,e){var n=this.path[t];if(f(e))if("-"===n)n=e.length;else{if(!n.match(/^[0-9]*$/))throw new c("Expected a number to segment an array");n=parseInt(n,10)}return n},p.prototype._action=function(t,i,a){var p=this;return function t(e,n){var r,o;if(a||(e=function(t){var e,n;if(f(t))return t.slice();if(null===t)return t;if("object"==typeof t){for(n in e={},t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}return t}(e)),r=p._get_segment(n,e),n==p.path.length-1)e=i(e,r);else{if(f(e)){if(e.length<=r)throw new c("Path not found in document")}else{if("object"!=typeof e)throw new c("Path not found in document");if(!Object.hasOwnProperty.call(e,r))throw new c("Path not found in document")}o=t(e[r],n+1),a||(e[r]=o)}return e}(t,0)},p.prototype.add=function(t,n,e){return 0===this.length?n:this._action(t,function(t,e){if(f(t)){if(e>t.length)throw new c("Add operation must not attempt to create a sparse array!");t.splice(e,0,n)}else t[e]=n;return t},e)},p.prototype.remove=function(t,e){if(0!==this.length)return this._action(t,function(t,e){if(!Object.hasOwnProperty.call(t,e))throw new c("Remove operation must point to an existing value!");return f(t)?t.splice(e,1):delete t[e],t},e)},p.prototype.replace=function(t,n,e){return 0===this.length?n:this._action(t,function(t,e){if(!Object.hasOwnProperty.call(t,e))throw new c("Replace operation must point to an existing value!");return f(t)?t.splice(e,1,n):t[e]=n,t},e)},p.prototype.get=function(t){var n;return 0===this.length?t:(this._action(t,function(t,e){if(!Object.hasOwnProperty.call(t,e))throw new c("Path not found in document");return n=t[e],t},!0),n)},p.prototype.subsetOf=function(t){if(this.length<=t.length)return!1;for(var e=0;e<t.length;e++)if(t.path[e]!==this.path[e])return!1;return!0},u={add:["value"],replace:["value"],test:["value"],remove:[],move:["from"],copy:["from"]},t.JSONPatch=window.JSONPatch=n=function(t,e){this._compile(t,e)},n.prototype._compile=function(t,e){var n;if(this.compiledOps=[],"string"==typeof t&&(t=JSON.parse(t)),!f(t))throw new a("Patch must be an array of operations");for(n=0;n<t.length;n++){var r=o(t[n],e);this.compiledOps.push(r)}},t.JSONPatch.prototype.apply=function(t){var e;for(e=0;e<this.compiledOps.length;e++)t=this.compiledOps[e](t);return t}});